var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,o=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,n=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&o(e,a,t[a]);if(i)for(var a of i(t))s.call(t,a)&&o(e,a,t[a]);return e},r=(e,t,a)=>new Promise(((i,l)=>{var s=e=>{try{n(a.next(e))}catch(t){l(t)}},o=e=>{try{n(a.throw(e))}catch(t){l(t)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,o);n((a=a.apply(e,t)).next())}));import{G as d,p as c,j as p,r as h,o as u,f as g,g as m,w as f,s as w,H as b,I as y,k as v,u as U}from"./vendor.ab24dc3f.js";import{i as x}from"./infoList.89930291.js";import{g as z,d as j}from"./fileUploadAndDownload.176ceac4.js";import{C}from"./index.921bfd6e.js";import{_ as S}from"./index.bf0eadd2.js";import"./dictionary.03156ab7.js";import"./date.23f5a973.js";const D=(e,t)=>{var a=new Image;a.setAttribute("crossOrigin","anonymous"),a.onload=function(){var e=document.createElement("canvas");e.width=a.width,e.height=a.height,e.getContext("2d").drawImage(a,0,0,a.width,a.height);var i=e.toDataURL("image/png"),l=document.createElement("a"),s=new MouseEvent("click");l.download=t||"photo",l.href=i,l.dispatchEvent(s)},a.src=e};class _{constructor(e,t,a=1920){this.file=e,this.fileSize=t,this.maxWH=a}compress(){const e=this.file.type,t=this.file.size/1024;return new Promise((a=>{const i=new FileReader;i.readAsDataURL(this.file),i.onload=()=>{const l=document.createElement("canvas"),s=document.createElement("img");s.src=i.result,s.onload=()=>{const i=l.getContext("2d"),o=this.dWH(s.width,s.height,this.maxWH);l.width=o.width,l.height=o.height,i.clearRect(0,0,l.width,l.height),i.drawImage(s,0,0,l.width,l.height);const n=l.toDataURL(e,.9),r=this.fileSizeKB(n);r>this.fileSize&&console.log("图片尺寸太大!"+t+" >> "+r);const d=this.dataURLtoBlob(n,e),c=new File([d],this.file.name);a(c)}}}))}dWH(e,t,a){const i={width:e,height:t};return Math.max(e,t)>a?e>t?(i.width=a,i.height=Math.round(t*(a/e)),i):(i.height=a,i.width=Math.round(e*(a/t)),i):i}fileSizeKB(e){let t=0;return t=Math.round(3*e.split(",")[1].length/4/1024),t}dataURLtoBlob(e,t){const a=atob(e.split(",")[1]);let i=e.split(",")[0].split(":")[1].split(";")[0];const l=new ArrayBuffer(a.length),s=new Uint8Array(l);for(let o=0;o<a.length;o++)s[o]=a.charCodeAt(o);return t&&(i=t),new Blob([l],{type:i,lastModifiedDate:new Date})}}const I={name:"UploadImage",model:{prop:"imageUrl",event:"change"},props:{imageUrl:{type:String,default:""},fileSize:{type:Number,default:2048},maxWH:{type:Number,default:1920}},data:()=>({path:"/api"}),computed:(k=n({},d("user",["userInfo","token"])),O={showImageUrl(){return this.imageUrl&&"http"!==this.imageUrl.slice(0,4)?"/api"+this.imageUrl:this.imageUrl}},t(k,a(O))),methods:{beforeImageUpload(e){const t="image/jpeg"===e.type,a="image/png"===e.type;if(!t&&!a)return this.$message.error("上传头像图片只能是 jpg或png 格式!"),!1;const i=e.size/1024<this.fileSize;if(!i){return new _(e,this.fileSize,this.maxWH).compress()}return i},handleImageSuccess(e){const{data:t}=e;t.file&&(this.$emit("change",t.file.url),this.$emit("on-success"))}}};var k,O;c("data-v-4bf0c336");const L=w("压缩上传");p();const $={name:"Upload",components:{CustomPic:C,UploadImage:S(I,[["render",function(e,t,a,i,l,s){const o=h("el-button"),n=h("el-upload");return u(),g("div",null,[m(n,{action:`${l.path}/fileUploadAndDownload/upload`,headers:{"x-token":e.token},"show-file-list":!1,"on-success":s.handleImageSuccess,"before-upload":s.beforeImageUpload,multiple:!1},{default:f((()=>[m(o,{size:"mini",type:"primary"},{default:f((()=>[L])),_:1})])),_:1},8,["action","headers","on-success","before-upload"])])}],["__scopeId","data-v-4bf0c336"]])},mixins:[x],data:()=>({fullscreenLoading:!1,listApi:z,path:"/api",tableData:[],imageUrl:""}),computed:n({},d("user",["userInfo","token"])),created(){this.getTableData()},methods:{deleteFile(e){return r(this,null,(function*(){this.$confirm("此操作将永久文件, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>r(this,null,(function*(){0===(yield j(e)).code&&(this.$message({type:"success",message:"删除成功!"}),1===this.tableData.length&&this.page>1&&this.page--,this.getTableData())})))).catch((()=>{this.$message({type:"info",message:"已取消删除"})}))}))},checkFile(e){this.fullscreenLoading=!0;const t="image/jpeg"===e.type,a="image/png"===e.type,i=e.size/1024/1024<.5;return t||a||(this.$message.error("上传图片只能是 jpg或png 格式!"),this.fullscreenLoading=!1),i||(this.$message.error("未压缩未见上传图片大小不能超过 500KB，请使用压缩上传"),this.fullscreenLoading=!1),(a||t)&&i},uploadSuccess(e){this.fullscreenLoading=!1,0===e.code?(this.$message({type:"success",message:"上传成功"}),0===e.code&&this.getTableData()):this.$message({type:"warning",message:e.msg})},uploadError(){this.$message({type:"error",message:"上传失败"}),this.fullscreenLoading=!1},downloadFile(e){e.url.indexOf("http://")>-1||e.url.indexOf("https://")>-1?D(e.url,e.name):D(this.path+e.url,e.name)}}};c("data-v-512e9724");const A={class:"gva-table-box"},P={class:"gva-btn-list"},B=w("普通上传"),E=w("下载"),F=w("删除"),H={class:"gva-pagination"};p();var R=S($,[["render",function(e,t,a,i,l,s){const o=h("el-button"),n=h("el-upload"),r=h("upload-image"),d=h("CustomPic"),c=h("el-table-column"),p=h("el-tag"),x=h("el-table"),z=h("el-pagination"),j=b("loading");return y((u(),g("div",null,[v("div",A,[v("div",P,[m(n,{action:`${l.path}/fileUploadAndDownload/upload`,"before-upload":s.checkFile,headers:{"x-token":e.token},"on-error":s.uploadError,"on-success":s.uploadSuccess,"show-file-list":!1,class:"upload-btn"},{default:f((()=>[m(o,{size:"mini",type:"primary"},{default:f((()=>[B])),_:1})])),_:1},8,["action","before-upload","headers","on-error","on-success"]),m(r,{modelValue:l.imageUrl,"onUpdate:modelValue":t[0]||(t[0]=e=>l.imageUrl=e),"file-size":512,"max-w-h":1080,class:"upload-btn",onOnSuccess:e.getTableData},null,8,["modelValue","onOnSuccess"])]),m(x,{data:l.tableData},{default:f((()=>[m(c,{align:"left",label:"预览",width:"100"},{default:f((e=>[m(d,{"pic-type":"file","pic-src":e.row.url},null,8,["pic-src"])])),_:1}),m(c,{align:"left",label:"日期",prop:"UpdatedAt",width:"180"},{default:f((t=>[v("div",null,U(e.formatDate(t.row.UpdatedAt)),1)])),_:1}),m(c,{align:"left",label:"文件名",prop:"name",width:"180"}),m(c,{align:"left",label:"链接",prop:"url","min-width":"300"}),m(c,{align:"left",label:"标签",prop:"tag",width:"100"},{default:f((e=>[m(p,{type:"jpg"===e.row.tag?"primary":"success","disable-transitions":""},{default:f((()=>[w(U(e.row.tag),1)])),_:2},1032,["type"])])),_:1}),m(c,{align:"left",label:"操作",width:"160"},{default:f((e=>[m(o,{size:"small",icon:"el-icon-download",type:"text",onClick:t=>s.downloadFile(e.row)},{default:f((()=>[E])),_:2},1032,["onClick"]),m(o,{size:"small",icon:"el-icon-delete",type:"text",onClick:t=>s.deleteFile(e.row)},{default:f((()=>[F])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"]),v("div",H,[m(z,{"current-page":e.page,"page-size":e.pageSize,"page-sizes":[10,30,50,100],style:{float:"right",padding:"20px"},total:e.total,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:e.handleCurrentChange,onSizeChange:e.handleSizeChange},null,8,["current-page","page-size","total","onCurrentChange","onSizeChange"])])])],512)),[[j,l.fullscreenLoading,void 0,{fullscreen:!0,lock:!0}]])}],["__scopeId","data-v-512e9724"]]);export{R as default};
